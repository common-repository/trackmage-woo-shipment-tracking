"use strict";!function(c,n,t){var r={main:n.trackmageAdmin,metaBoxes:n.trackmageAdminMetaBoxes};function a(e,t){c(e).selectWoo({width:"100%",ajax:{url:r.main.urls.ajax,method:"post",dataType:"json",delay:250,data:function(e){return{term:e.term,action:"trackmage_get_order_items",orderId:t}},processResults:function(e){return{results:e.map(function(e){return{id:e.id,text:e.name}})}}}})}function m(e){c("#trackmage-shipment-tracking .actions__action-group").hide(),c("#trackmage-shipment-tracking [data-action-group]").hide();var t=c("#trackmage-shipment-tracking .actions__action-group--".concat(e));return c(t).show(),c("#trackmage-shipment-tracking [data-action-group=".concat(e,"]")).show(),t}function i(e,t){t=1<arguments.length&&void 0!==t&&t,e=c(e).data("id");c.ajax({url:r.main.urls.ajax,method:"post",data:{action:"trackmage_delete_shipment",security:r.metaBoxes.nonces.deleteShipment,orderId:r.metaBoxes.orderId,id:e,unlink:t},beforeSend:function(){trackmageBlockUi(c("#trackmage-shipment-tracking .inside"))},success:function(e){var t={title:e.success?r.main.i18n.success:r.main.i18n.failure,message:e.data.message||(e.success?"":r.main.i18n.unknownError),type:e.success?"success":"failure"},t=(trackmageAlert(t.title,t.message,t.type,!0),c("#trackmage-shipment-tracking .inside").html(e.data.html),c("ul.order_notes").parent());c("ul.order_notes").remove(),t.prepend(c(e.data.notes))},error:function(e){e=(null==e||null==(e=e.data)?void 0:e.message)||r.main.i18n.unknownError;trackmageAlert(r.main.i18n.failure,e,"failure",!0)},complete:function(){trackmageUnblockUi(c("#trackmage-shipment-tracking .inside"))}})}c(t).on("click","#trackmage-shipment-tracking .items__btn-add-row",function(e){e.preventDefault();var t=c(this);c.ajax({url:r.main.urls.ajax,method:"post",data:{action:"trackmage_get_view",path:"order-add-shipment-items-row.php"},beforeSend:function(){trackmageBlockUi(c("#trackmage-shipment-tracking .inside"))},success:function(e){e=c(e.data.html);c(e).find(".items__delete").css("display","block"),a(c(e).find('[name="order_item_id"]'),r.metaBoxes.orderId),c(t).before(e)},error:function(e){e=(null==e||null==(e=e.data)?void 0:e.message)||r.main.i18n.unknownError;trackmageAlert(r.main.i18n.failure,e,"failure",!0)},complete:function(){trackmageUnblockUi(c("#trackmage-shipment-tracking .inside"))}})}),c(t).on("click","#trackmage-shipment-tracking .items__row .items__delete",function(e){e.preventDefault();e=c(this).closest(".items__row");c(e).remove()}),c(t).on("click","#trackmage-shipment-tracking .shipment__actions__action--edit",function(e){var a=c(this).closest("tr.shipment"),s=c(a).data("id"),t=c(a).find(".shipment__actions").eq(0),n=c("div.actions .actions__action-group.actions__action-group--edit").clone();c(t).find(".shipment__actions__wrap").hide(),c(t).append(n),c(n).addClass("shipment__actions__wrap").show(),c(n).off("click",".btn-cancel").on("click",".btn-cancel",function(e){e.preventDefault(),c(n).remove(),c(t).find(".shipment__actions__wrap").show(),c("#trackmage-shipment-tracking tr#edit-tr-"+s).remove()}),c(n).off("click",".btn-save").on("click",".btn-save",function(e){e.preventDefault();var a=[],e=(c("#trackmage-shipment-tracking tr#edit-tr-"+s+" .edit-shipment .items__rows .items__row").each(function(){var e=c(this).find('[name="id"]').val(),t=c(this).find('[name="order_item_id"]').val(),n=c(this).find('[name="qty"]').val();0<n&&a.push({id:e,order_item_id:t,qty:n})}),{action:"trackmage_update_shipment",security:r.metaBoxes.nonces.updateShipment,orderId:r.metaBoxes.orderId,id:s,trackingNumber:c("#trackmage-shipment-tracking tr#edit-tr-"+s+' .edit-shipment [name="tracking_number"]').val(),carrier:c("#trackmage-shipment-tracking tr#edit-tr-"+s+' .edit-shipment [name="carrier"]').val(),items:a});c.ajax({url:r.main.urls.ajax,method:"post",data:e,beforeSend:function(){trackmageBlockUi(c("#trackmage-shipment-tracking .inside"))},success:function(e){var t,n,a,i;!1===(null==e?void 0:e.success)&&null!=e&&null!=(i=e.data)&&i.shipmentId&&((null==e||null==(i=e.data)?void 0:i.message)||"").includes("It seems that you are trying to add the same tracking number to two different shipments")?(t=null==e||null==(i=e.data)?void 0:i.shipmentId,n=null==e||null==(i=e.data)?void 0:i.trackingNumber,a=c("<div>It seems that you are trying to add tracking number ".concat(n.toUpperCase()," to two different shipments. Please use a different tracking number or connect to existing shipment.</div>")),trackmageConfirmDialog(a,function(){var e={action:"trackmage_merge_shipments",security:r.metaBoxes.nonces.mergeShipments,trackingNumber:n,shipmentId:t,orderId:r.metaBoxes.orderId};c.ajax({url:r.main.urls.ajax,method:"post",data:e,beforeSend:function(){trackmageBlockUi(c("#trackmage-shipment-tracking .inside")),c(a).dialog("close")},success:function(e){var t={title:null!=e&&e.success?r.main.i18n.success:r.main.i18n.failure,message:null!=e&&null!=(t=e.data)&&t.message?e.data.message:null!=e&&e.success?"":r.main.i18n.unknownError,type:null!=e&&e.success?"success":"failure"},t=(trackmageAlert(t.title,t.message,t.type,!0),c("#trackmage-shipment-tracking .inside").html(e.data.html),c("ul.order_notes").parent());c("ul.order_notes").remove(),t.prepend(c(e.data.notes))},error:function(e){e=(null==e||null==(e=e.data)?void 0:e.message)||r.main.i18n.unknownError;trackmageAlert(r.main.i18n.failure,e,"failure",!0)},complete:function(){trackmageUnblockUi(c("#trackmage-shipment-tracking .inside"))}})},"Error","Connect to existing")):(i={title:null!=e&&e.success?r.main.i18n.success:r.main.i18n.failure,message:null!=e&&null!=(i=e.data)&&i.message?e.data.message:null!=e&&e.success?"":r.main.i18n.unknownError,type:null!=e&&e.success?"success":"failure"},trackmageAlert(i.title,i.message,i.type,!0),c("#trackmage-shipment-tracking .inside").html(e.data.html),i=c("ul.order_notes").parent(),c("ul.order_notes").remove(),i.prepend(c(e.data.notes)))},error:function(e){e=(null==e||null==(e=e.data)?void 0:e.message)||r.main.i18n.unknownError;trackmageAlert(r.main.i18n.failure,e,"failure",!0)},complete:function(){trackmageUnblockUi(c("#trackmage-shipment-tracking .inside"))}})}),c.ajax({url:r.main.urls.ajax,method:"post",data:{action:"trackmage_edit_shipment",id:s,security:r.metaBoxes.nonces.editShipment,orderId:r.metaBoxes.orderId},beforeSend:function(){trackmageBlockUi(c("#trackmage-shipment-tracking .inside"))},success:function(e){var t,n,i,r;e.success?(t=c(e.data.html),e.data.trackingNumber,n=e.data.carrier,i=e.data.items,c(t).find(".items__rows .items__row .items__delete").css("display","block"),e=c("#trackmage-shipment-tracking .shipments + .edit-shipment").clone().append(c(t)).show(),e=c("<tr></tr>").attr("id","edit-tr-"+s).append(c("<td></td>").attr("style","padding: 0 !important").attr("colspan",5).append(c(e))),c(e).insertAfter(c(a)),c(t).find('[name="carrier"]').selectWoo({width:"100%"}).val(n).trigger("change"),r=1,Object.keys(i).forEach(function(e){var e=i[e],t=c("#trackmage-shipment-tracking tr#edit-tr-".concat(s," .edit-shipment .items__rows .items__row:nth-of-type(").concat(r,")")),n=c(t).find('[name="id"]'),a=c(t).find('[name="order_item_id"]'),t=c(t).find('[name="qty"]');c(n).val(e.id),c(t).val(e.qty),a.parent().append(c("<span></span>").text(e.name)).append(c('<input type="hidden" name="order_item_id">').val(e.order_item_id)),a.remove(),r++})):m("default")},complete:function(){trackmageUnblockUi(c("#trackmage-shipment-tracking .inside"))}})}),c(t).on("click","#trackmage-shipment-tracking .actions__action-group--default .btn-new",function(e){e.preventDefault(),c("#trackmage-shipment-tracking .add-shipment").show();e=m("new");c('#trackmage-shipment-tracking .add-shipment [name="add_all_order_items"]').off("change").on("change",function(e){var t=c(this).is(":checked"),n=c("#trackmage-shipment-tracking .add-shipment .items__rows");t?c(n).hide():c(n).show()}).trigger("click"),c('#trackmage-shipment-tracking .add-shipment [name="carrier"]').selectWoo({width:"100%"}),a(c('#trackmage-shipment-tracking .add-shipment [name="order_item_id"]'),r.metaBoxes.orderId),c(e).off("click",".btn-cancel").on("click",".btn-cancel",function(e){e.preventDefault(),m("default"),c("#trackmage-shipment-tracking .add-shipment").hide()}),c(t).off("click","#trackmage-shipment-tracking .actions__action-group--new .btn-add-shipment").on("click","#trackmage-shipment-tracking .actions__action-group--new .btn-add-shipment",function(e){e.preventDefault();var n=[],e=(c("#trackmage-shipment-tracking .add-shipment .items__rows .items__row").each(function(){var e=c(this).find('[name="order_item_id"]').val(),t=c(this).find('[name="qty"]').val();n.push({id:"",order_item_id:e,qty:t})}),{action:"trackmage_add_shipment",security:r.metaBoxes.nonces.addShipment,orderId:r.metaBoxes.orderId,trackingNumber:c('#trackmage-shipment-tracking .add-shipment [name="tracking_number"]').val(),carrier:c('#trackmage-shipment-tracking .add-shipment [name="carrier"]').val(),addAllOrderItems:c('#trackmage-shipment-tracking .add-shipment [name="add_all_order_items"]').is(":checked"),items:n});c.ajax({url:r.main.urls.ajax,method:"post",data:e,beforeSend:function(){trackmageBlockUi(c("#trackmage-shipment-tracking .inside"))},success:function(e){var t={title:e.success?r.main.i18n.success:r.main.i18n.failure,message:e.data.message||(e.success?"":r.main.i18n.unknownError),type:e.success?"success":"failure"},t=(trackmageAlert(t.title,t.message,t.type,!0),c("#trackmage-shipment-tracking .inside").html(e.data.html),c("ul.order_notes").parent());c("ul.order_notes").remove(),t.prepend(c(e.data.notes))},error:function(e){e=(null==e||null==(e=e.data)?void 0:e.message)||r.main.i18n.unknownError;trackmageAlert(r.main.i18n.failure,e,"failure",!0)},complete:function(){trackmageUnblockUi(c("#trackmage-shipment-tracking .inside"))}})})}),c(t).on("click","#trackmage-shipment-tracking .shipment__actions__action--delete",function(e){e.preventDefault();var t=c(this).closest(".shipment");n.trackmageConfirmDialog("#delete-shipment-confirm-dialog",function(){return!0},r.metaBoxes.i18n.confirmDeleteShipment,r.metaBoxes.i18n.yes).then(function(e){if("yes"!==e)return!1;i(t)})}),c(t).on("click","#trackmage-shipment-tracking .shipment__actions__action--unlink",function(e){e.preventDefault();var t=c(this).closest(".shipment");n.trackmageConfirmDialog("#delete-shipment-confirm-dialog",function(){return!0},r.metaBoxes.i18n.confirmUnlinkShipment,r.metaBoxes.i18n.yes).then(function(e){if("yes"!==e)return!1;i(t,!0)})}),c(t).on("click","#order_data a.edit_address",function(e){trackmageBlockUi(c("#trackmage-shipment-tracking .inside")),c("#trackmage-shipment-tracking h2 .blocked-shipments").length<1&&c("#trackmage-shipment-tracking h2").append('<span class="blocked-shipments" style="color: #f00; margin-left: 10px;"> - '+r.main.i18n.cannot_edit+"</span>")})}(jQuery,window,document);